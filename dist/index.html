<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Toasters vs Loaves â€” Modular</title>
  <style>
    :root{
      --bg:#0f0f14;--panel:#16161d;--panel2:#1d1d27;--text:#e7e7ee;--accent:#ffb347;--accent2:#ffd166;--good:#7bd88f;--bad:#ff6b6b;--muted:#a1a1b3;--wire:#34344a;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#0b0b10,#14141b);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  .wrap{display:grid;grid-template-columns:1fr 240px;grid-template-rows:1fr;gap:10px;height:100%;padding:10px}
  #gamePanel{height:100%;display:block}
  .wrap.menu-mode{grid-template-columns:1fr}
    #gamePanel{position:relative;border:1px solid #27273a;border-radius:14px;overflow:hidden;background:#0c0f15}
    canvas{display:block;background:#0a0d12}
    .hud{position:absolute;inset:0;pointer-events:none}
    .topbar{position:absolute;left:10px;right:10px;top:10px;display:flex;gap:10px;pointer-events:auto}
    .pill{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.06);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,0.08);display:flex;gap:12px;align-items:center}
    .pill b{color:var(--accent)}
    .btn{cursor:pointer;user-select:none}
    .btn.primary{background:linear-gradient(180deg,var(--accent),var(--accent2));color:#222;font-weight:700;border:none}
    .btn.small{font-size:12px;padding:6px 10px}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .side{background:var(--panel);border:1px solid #29293f;border-radius:14px;padding:10px;display:flex;flex-direction:column;gap:10px;overflow:auto;-webkit-overflow-scrolling:touch}
    
    /* Sell button and range toggle styling */
    .sell-btn{background:linear-gradient(135deg,var(--bad),#ff5555);color:white;font-weight:600;padding:8px 16px;border:none;border-radius:8px;transition:all 0.2s ease}
    .sell-btn:disabled{background:#2d3748;color:var(--muted);cursor:not-allowed}
    .sell-btn:hover:not(:disabled){background:linear-gradient(135deg,#ff5555,var(--bad));transform:translateY(-1px)}
    .range-toggle{display:flex;align-items:center;gap:8px;font-size:12px;cursor:pointer}
    .range-toggle input{margin:0}
    
    .section{background:var(--panel2);border:1px solid #2d2d45;border-radius:12px;padding:10px}
    h2,h3{margin:0 0 8px 0;font-weight:800}
    .catalog{display:grid;grid-template-columns:1fr;gap:8px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .small{color:var(--muted);font-size:12px}
    .tech-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .tech{padding:8px;border-radius:8px;background:#131420;border:1px solid #2b2e46;display:flex;flex-direction:column;gap:6px}
    .tech.locked{opacity:.6}
    .tech .buy{padding:6px;border-radius:6px;background:#0d0f18;border:1px solid #2b2e46;cursor:pointer}
    .keyline{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.06),transparent);margin:6px 0}
    .log{height:120px;overflow:auto;font-family:ui-monospace,Consolas,monospace;background:#0c0f14;border:1px solid #22243a;border-radius:8px;padding:8px}
    .hint{font-size:12px;color:var(--muted)}
    .floating{position:absolute;transform:translate(-50%,-50%);pointer-events:none}
    .badge{padding:2px 6px;border-radius:6px;background:#10141f;border:1px solid #29304b;font-size:11px}
    .tooltip{position:absolute;left:50%;transform:translate(-50%,-110%);background:#111522;border:1px solid #2b2f49;border-radius:8px;padding:6px 8px;white-space:nowrap;font-size:12px;pointer-events:none}
    .ability{display:flex;justify-content:space-between;align-items:center;padding:8px;margin:4px 0;border-radius:6px;background:#131420;border:1px solid #2b2e46}
    .ability.ready{border-color:#4ade80;background:#1a2e1a}
    .ability.cooldown{opacity:0.6}
    .ability-info{flex:1}
    .ability-key{background:#2d3748;color:#e2e8f0;padding:2px 6px;border-radius:4px;font-size:11px;margin-left:8px}
    .cooldown-bar{height:3px;background:#334155;border-radius:2px;margin-top:4px;overflow:hidden}
    .cooldown-progress{height:100%;background:#ef4444;transition:width 0.1s}
    .achievement{display:flex;align-items:center;padding:6px;margin:3px 0;border-radius:6px;background:#131420;border:1px solid #2b2e46}
    .achievement.unlocked{border-color:#4ade80;background:#1a2e1a}
    .achievement.locked{opacity:0.5}
    .achievement-icon{font-size:16px;margin-right:8px;min-width:20px}
    .achievement-text{flex:1;font-size:11px}
    .achievement-name{font-weight:bold;margin-bottom:2px}
    .achievement-desc{color:#a1a1b3}
    
    /* Upgrade Path System CSS */
    .upgrade-paths{display:flex;flex-direction:column;gap:12px;margin-top:8px}
    .upgrade-path{background:#101420;border:1px solid #2b2e46;border-radius:8px;padding:8px}
    .path-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .path-header strong{color:var(--accent);font-size:13px}
    .tier-indicator{font-size:11px;color:var(--muted);background:#1d1d27;padding:2px 6px;border-radius:4px}
    .path-progress{display:flex;gap:4px;margin-bottom:8px}
    .tier-bubble{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:bold;cursor:pointer}
    .tier-owned{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000}
    .tier-next{background:#2d3748;color:var(--text);border:2px solid var(--accent)}
    .tier-locked{background:#16161d;color:var(--muted);border:1px solid #2b2e46}
    .upgrade-info{display:flex;flex-direction:column;gap:4px}
    .upgrade-name{font-weight:bold;font-size:12px;color:var(--text)}
    .upgrade-tip{font-size:11px;color:var(--muted)}
    .maxed{font-size:11px;color:var(--good);font-weight:bold}
    .blocked{font-size:11px;color:var(--bad)}
    
    /* Tower Upgrade Popup Styles */
    .tower-popup{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:1000;animation:popupFadeIn 0.2s ease-out}
    .popup-content{background:var(--panel);border:1px solid #29293f;border-radius:16px;width:90%;max-width:500px;max-height:80vh;overflow:hidden;box-shadow:0 20px 40px rgba(0,0,0,0.5);animation:popupSlideIn 0.3s ease-out}
    .popup-header{background:var(--panel2);padding:16px 20px;border-bottom:1px solid #29293f;display:flex;justify-content:space-between;align-items:center}
    .popup-header h2{margin:0;color:var(--accent);font-size:18px}
    .popup-close{background:none;border:none;color:var(--muted);font-size:24px;cursor:pointer;padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.2s}
    .popup-close:hover{background:var(--bad);color:white;transform:scale(1.1)}
    .popup-body{padding:20px;overflow-y:auto;max-height:calc(80vh - 80px)}
    .popup-actions{margin-top:20px;padding-top:16px;border-top:1px solid #29293f;display:flex;justify-content:center}
    .popup-actions .sell-btn{background:linear-gradient(135deg,var(--bad),#ff5555);color:white;font-weight:600;padding:10px 20px;border:none;border-radius:8px;font-size:14px;transition:all 0.2s}
    .popup-actions .sell-btn:hover{background:linear-gradient(135deg,#ff5555,var(--bad));transform:translateY(-1px);box-shadow:0 4px 12px rgba(255,107,107,0.3)}
    .popup-tower-stats{background:#101420;border:1px solid #2b2e46;border-radius:8px;padding:12px;margin-bottom:16px}
    .popup-tower-stats .stat-row{display:flex;justify-content:space-between;margin-bottom:4px;font-size:13px}
    .popup-tower-stats .stat-label{color:var(--muted)}
    .popup-tower-stats .stat-value{color:var(--text);font-weight:600}
    
    @keyframes popupFadeIn{from{opacity:0}to{opacity:1}}
    @keyframes popupSlideIn{from{opacity:0;transform:scale(0.9) translateY(-20px)}to{opacity:1;transform:scale(1) translateY(0)}}
    
    /* Enhanced card animations */
    .card{background:#12121a;border:1px solid #2b2b40;border-radius:10px;padding:6px;display:flex;flex-direction:column;gap:4px;transition:all 0.2s ease}
    .card:hover{border-color:#3a3a56;transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.3)}
    .card.selected{border-color:var(--accent);background:#1a1520;box-shadow:0 0 0 2px rgba(255,179,71,0.3)}
    .card.insufficient-funds{opacity:0.6;cursor:not-allowed}
    .card.insufficient-funds:hover{transform:none;box-shadow:none}
    
    .placeBtn{padding:6px;border-radius:8px;border:1px dashed #3a3a56;background:#0e0e15;cursor:pointer;font-size:12px;transition:all 0.2s ease}
    .placeBtn:hover{background:#131321;border-color:var(--accent);color:var(--accent)}
    .placeBtn:active{transform:scale(0.98)}
    .placeBtn.selected{background:var(--accent);color:#000;border-color:var(--accent);border-style:solid}
    .placeBtn.selected:hover{background:var(--accent2)}
    .placeBtn:disabled{opacity:0.5;cursor:not-allowed;background:#0e0e15;color:var(--muted)}
    .placeBtn:disabled:hover{background:#0e0e15;border-color:#3a3a56;color:var(--muted);transform:none}
    
    .badge.insufficient{color:var(--bad)}
    
    
    /* Upgrade button enhancements */
    .upgrade-btn{padding:6px 10px;border-radius:6px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000;border:none;font-weight:600;font-size:11px;transition:all 0.2s ease;cursor:pointer}
    .upgrade-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(255,179,71,0.4)}
    .upgrade-btn:active{transform:scale(0.98)}
    .upgrade-btn:disabled{background:#2d3748;color:var(--muted);transform:none;box-shadow:none}
    
    /* Tier bubble animations */
    .tier-bubble{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:bold;cursor:pointer;transition:all 0.2s ease}
    .tier-bubble:hover{transform:scale(1.1)}
    .tier-owned{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000}
    .tier-next{background:#2d3748;color:var(--text);border:2px solid var(--accent);animation:tierPulse 2s infinite}
    .tier-locked{background:#16161d;color:var(--muted);border:1px solid #2b2e46}
    
    @keyframes tierPulse{0%,100%{box-shadow:0 0 0 0 rgba(255,179,71,0.4)}50%{box-shadow:0 0 0 4px rgba(255,179,71,0)}}
    
    /* Menu System Styles */
    
    /* Title Screen */
    .title-screen {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #0a0d12 0%, #1a1d2e 50%, #0f1419 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      animation: titleFadeIn 1s ease-out;
    }
    
    .title-content {
      text-align: center;
      max-width: 600px;
      padding: 40px;
    }
    
  :root { --title-glow: 0; --title-glow-scale: 1; }
    .game-title {
      position: relative;
      font-size: 3.5rem;
      font-weight: 900;
      color: var(--accent);
      margin: 0 0 20px 0;
      /* Direct amplitude (0=no glow, 1=max). Combine with user scale. */
  --g: calc(var(--title-glow) * var(--title-glow-scale));
  --gb: calc(var(--title-glow-bright) * var(--title-glow-scale));
      /* Minimal readable stroke via text-shadow only when glow present */
      text-shadow:
        0 0 calc(6px + 10px * var(--gb)) rgba(255,179,71, calc(0.55 * var(--gb))),
        0 0 calc(24px + 60px * var(--gb)) rgba(255,210,120, calc(0.40 * var(--gb))),
        0 0 calc(50px + 120px * var(--gb)) rgba(255,140,0, calc(0.28 * var(--gb))),
        0 0 calc(90px + 200px * var(--gb)) rgba(255,90,0, calc(0.16 * var(--gb)));
      animation: titlePulse 3s ease-in-out infinite;
      transition: text-shadow 0.1s linear;
    }
    .game-title::after {
      content: '';
      position: absolute;
      inset: 0;
      left: 50%;
      top: 50%;
  transform: translate(-50%, -50%) scale(calc(0.35 + 0.75 * var(--gb)));
      width: 160%;
      height: 160%;
      background: radial-gradient(circle at 50% 50%, rgba(255,185,80,0.55) 0%, rgba(255,140,0,0.28) 35%, rgba(255,120,0,0.08) 60%, rgba(255,90,0,0.0) 75%);
  filter: blur(calc(16px + 80px * var(--gb)));
  opacity: calc(var(--gb));
      pointer-events: none;
      z-index: -1;
      mix-blend-mode: screen;
      transition: opacity 0.12s linear, transform 0.25s ease, filter 0.18s linear;
    }
    
    .title-subtitle {
      font-size: 1.2rem;
      color: var(--muted);
      margin-bottom: 40px;
      opacity: 0.8;
    }
    
    .title-artwork {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 30px;
      margin: 40px 0;
      font-size: 4rem;
    }
    
    .toaster-icon, .bread-icon {
      animation: bounce 2s ease-in-out infinite;
    }
    
    .bread-icon {
      animation-delay: 0.5s;
    }
    
    .vs-text {
      font-weight: 900;
      color: var(--accent2);
      font-size: 2rem;
      text-shadow: 0 2px 10px rgba(255, 209, 102, 0.5);
    }
    
    .title-footer {
      margin-top: 40px;
      opacity: 0.6;
    }
    
    .version {
      font-size: 0.9rem;
      color: var(--muted);
    }
    
    /* Kitchen HQ */
    .kitchen-hq {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #0a0d12 0%, #1a1d2e 30%, #0f1419 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      animation: slideIn 0.5s ease-out;
      overflow-y: auto;
    }
    
    .hq-content {
      max-width: 900px;
      width: 90%;
      padding: 40px 20px;
    }
    
    .hq-header {
      text-align: center;
      margin-bottom: 40px;
    }
    
    .hq-header h1 {
      font-size: 2.5rem;
      font-weight: 900;
      color: var(--accent);
      margin: 0 0 10px 0;
    }
    
    .hq-subtitle {
      font-size: 1.1rem;
      color: var(--muted);
      opacity: 0.8;
    }
    
    .hq-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }
    
    .hq-card {
      background: var(--panel);
      border: 1px solid #29293f;
      border-radius: 16px;
      padding: 30px 20px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    
    .hq-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 179, 71, 0.1), transparent);
      transition: left 0.5s ease;
    }
    
    .hq-card:hover::before {
      left: 100%;
    }
    
    .hq-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      border-color: var(--accent);
    }
    
    .card-icon {
      font-size: 3rem;
      margin-bottom: 15px;
      animation: cardIconFloat 3s ease-in-out infinite;
    }
    
    .play-card .card-icon { animation-delay: 0s; }
    .wiki-card .card-icon { animation-delay: 0.5s; }
    .tech-card .card-icon { animation-delay: 1s; }
    .settings-card .card-icon { animation-delay: 1.5s; }
    
    .hq-card h3 {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--text);
      margin: 0 0 10px 0;
    }
    
    .hq-card p {
      color: var(--muted);
      margin: 0 0 20px 0;
      line-height: 1.5;
    }
    
    .hq-stats {
      background: var(--panel2);
      border: 1px solid #2d2d45;
      border-radius: 12px;
      padding: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }
    
    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .stat-label {
      color: var(--muted);
      font-weight: 600;
    }
    
    .stat-value {
      color: var(--accent);
      font-weight: 700;
      font-size: 1.1rem;
    }
    
    /* Level Selection */
    .level-select, .map-select {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #0a0d12 0%, #1a1d2e 30%, #0f1419 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      /* top-aligned to avoid header clipping at certain viewport heights */
      justify-content: flex-start;
      animation: slideIn 0.5s ease-out;
      overflow-y: auto;
      padding-top: clamp(20px, 4vh, 80px);
      padding-bottom: 40px;
      -webkit-overflow-scrolling: touch;
    }
    
    .level-content, .map-content {
      max-width: 1000px;
      width: min(1000px, 94%);
      padding: clamp(24px, 4vh, 48px) 20px 0 20px;
    }
    
    .level-header, .map-header {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 0 40px 0;
      position: relative;
      padding-top: env(safe-area-inset-top, 0);
    }
    
    .back-btn {
      position: absolute;
      left: 0;
      background: var(--panel);
      border: 1px solid #29293f;
      color: var(--text);
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .back-btn:hover {
      background: var(--panel2);
      border-color: var(--accent);
      color: var(--accent);
    }
    
    .level-header h1, .map-header h1 {
      font-size: clamp(2rem, 5vw, 2.8rem);
      font-weight: 900;
      color: var(--accent);
      margin: 0;
      text-align: center;
      line-height: 1.05;
    }
    
    .level-subtitle, .map-subtitle {
      font-size: 1.1rem;
      color: var(--muted);
      text-align: center;
      margin-top: 10px;
    }
    
    .levels-grid, .maps-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: clamp(16px, 2vw, 28px);
      margin: 0 0 30px 0;
      width: 100%;
    }

    /* Responsive adjustments */
    /* Allow sidebar for iPad-sized screens and larger */
    @media (max-width: 768px) {
      .wrap:not(.menu-mode){
        grid-template-columns: 1fr; /* collapse sidebar under canvas for smaller screens */
        grid-auto-rows: auto;
      }
      aside.side { order: 2; }
      #gamePanel { order: 1; }
    }
    
    /* For medium screens (iPad portrait), make sidebar smaller to fit better */
    @media (min-width: 769px) and (max-width: 1024px) {
      .wrap:not(.menu-mode){
        grid-template-columns: 1fr 200px; /* slightly smaller sidebar for medium screens */
      }
      .side {
        font-size: 0.9em; /* slightly smaller text */
      }
    }
    @media (max-width: 900px), (max-height: 640px) {
      .level-content, .map-content { padding-top: 32px; }
      .levels-grid, .maps-grid { grid-template-columns: repeat(auto-fill, minmax(240px,1fr)); }
      .level-card, .map-card { padding: 16px; }
    }
    @media (max-width: 600px) {
      .level-header h1, .map-header h1 { font-size: clamp(1.8rem, 7vw, 2.2rem); }
      .back-btn { padding: 10px 14px; font-size: 0.85rem; }
    }
    
    .level-card, .map-card {
      background: var(--panel);
      border: 1px solid #29293f;
      border-radius: 16px;
      padding: 20px;
      display: flex;
      gap: 15px;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    
    .level-card.unlocked:hover, .map-card.unlocked:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      border-color: var(--accent);
    }
    
    .level-card.locked, .map-card.locked {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .level-card.completed {
      border-color: var(--good);
      background: linear-gradient(135deg, var(--panel), rgba(123, 216, 143, 0.1));
    }
    
    .level-number {
      background: var(--accent);
      color: #000;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 1.2rem;
      flex-shrink: 0;
    }
    
    .level-card.completed .level-number {
      background: var(--good);
    }
    
    .level-card.locked .level-number {
      background: var(--muted);
    }
    
    .level-info, .map-info {
      flex: 1;
    }
    
    .level-info h3, .map-info h3 {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text);
      margin: 0 0 8px 0;
    }
    
    .level-info p, .map-info p {
      color: var(--muted);
      margin: 0 0 12px 0;
      line-height: 1.4;
      font-size: 0.95rem;
    }
    
    .level-stats {
      display: flex;
      gap: 15px;
      margin-bottom: 8px;
    }
    
    .difficulty {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .difficulty.easy {
      background: rgba(123, 216, 143, 0.2);
      color: var(--good);
    }
    
    .difficulty.medium {
      background: rgba(255, 179, 71, 0.2);
      color: var(--accent);
    }
    
    .difficulty.hard {
      background: rgba(255, 107, 107, 0.2);
      color: var(--bad);
    }
    
    .difficulty.expert {
      background: rgba(138, 43, 226, 0.2);
      color: #a855f7;
    }
    
    .waves {
      color: var(--muted);
      font-size: 0.85rem;
      font-weight: 600;
    }
    
    .best-score {
      font-size: 0.85rem;
      color: var(--good);
      font-weight: 600;
    }
    
    .level-status, .map-status {
      font-size: 1.5rem;
      display: flex;
      align-items: center;
    }
    
    /* Map-specific styles */
    .map-preview {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      background: var(--panel2);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      border: 1px solid #29293f;
    }
    
    .map-theme {
      font-size: 2rem;
    }
    
    .map-layout {
      margin-bottom: 8px;
    }
    
    .layout-info {
      font-size: 0.85rem;
      color: var(--muted);
      font-style: italic;
    }
    
    .special-features {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 8px;
    }
    
    .feature-tag {
      background: var(--accent)20;
      color: var(--accent);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.8rem;
    }
    
    .best-waves {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    
    .best-label {
      font-size: 0.85rem;
      color: var(--muted);
      font-weight: 600;
    }
    
    .wave-record {
      background: var(--good)20;
      color: var(--good);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .map-info-panel, .infinite-wave-info {
      background: var(--panel2);
      border: 1px solid #2d2d45;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    
    .map-info-panel h3, .infinite-wave-info h3 {
      margin: 0 0 12px 0;
      color: var(--accent);
    }
    
    .map-info-panel p, .infinite-wave-info p {
      margin: 0 0 8px 0;
      line-height: 1.5;
    }
    
    /* Difficulty Selection */
    .difficulty-select {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #0a0d12 0%, #1a1d2e 30%, #0f1419 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      animation: slideIn 0.5s ease-out;
      overflow-y: auto;
      padding-top: clamp(20px, 4vh, 80px);
      padding-bottom: 48px;
      -webkit-overflow-scrolling: touch;
    }
    
    .difficulty-content {
      max-width: 1200px;
      width: min(1200px, 94%);
      padding: clamp(24px, 4vh, 56px) 20px 0 20px;
    }
    
    .difficulty-header {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 0 40px 0;
      position: relative;
      padding-top: env(safe-area-inset-top, 0);
    }
    
    .selected-map-info {
      text-align: center;
    }
    
    .selected-map-info h1 {
      font-size: clamp(2rem, 5vw, 2.8rem);
      font-weight: 900;
      color: var(--accent);
      margin: 0 0 8px 0;
      line-height: 1.05;
    }
    
    .selected-map-name {
      font-size: 1.1rem;
      color: var(--muted);
      opacity: 0.8;
    }
    
    .difficulties-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: clamp(16px, 2vw, 28px);
      margin: 0 0 30px 0;
      width: 100%;
    }

    @media (max-width: 900px), (max-height: 640px) {
      .difficulty-content { padding-top: 32px; }
      .difficulties-grid { grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); }
      .difficulty-card { padding: 16px; }
    }
    @media (max-width: 600px) {
      .selected-map-info h1 { font-size: clamp(1.8rem, 7vw, 2.2rem); }
    }
    
    .difficulty-card {
      background: var(--panel);
      border: 1px solid #29293f;
      border-radius: 16px;
      padding: 20px;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    
    .difficulty-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }
    
    .difficulty-icon {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      margin: 0 auto 16px auto;
    }
    
    .difficulty-info h3 {
      font-size: 1.4rem;
      font-weight: 700;
      margin: 0 0 8px 0;
      text-align: center;
    }
    
    .difficulty-info p {
      color: var(--muted);
      margin: 0 0 16px 0;
      line-height: 1.4;
      text-align: center;
    }
    
    .difficulty-stats {
      background: var(--panel2);
      border: 1px solid #2d2d45;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
    }
    
    .stat-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    
    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
    }
    
    .stat-label {
      color: var(--muted);
    }
    
    .stat-value {
      color: var(--text);
      font-weight: 600;
    }
    
    .personal-best {
      background: var(--good)20;
      color: var(--good);
      padding: 8px 12px;
      border-radius: 6px;
      text-align: center;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 16px;
    }
    
    .start-game-btn {
      width: 100%;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .start-game-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    
    /* Menu Buttons */
    .menu-btn {
      background: var(--panel2);
      color: var(--text);
      border: 1px solid #29293f;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 1rem;
      min-width: 120px;
    }
    
    .menu-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      transform: translateY(-1px);
    }
    
    .menu-btn.primary {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #000;
      border-color: var(--accent);
      font-weight: 700;
    }
    
    .menu-btn.primary:hover {
      background: linear-gradient(135deg, var(--accent2), var(--accent));
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 179, 71, 0.4);
    }
    
    .menu-btn.secondary {
      background: var(--panel);
      border-color: #29293f;
    }
    
    .menu-btn.secondary:hover {
      background: var(--panel2);
    }
    
    /* Animations */
    @keyframes titleFadeIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes titlePulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.02);
      }
    }
    
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(-10px);
      }
      60% {
        transform: translateY(-5px);
      }
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes cardIconFloat {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-5px);
      }
    }
    
    /* Menu container should be hidden when game is running */
    #menuContainer.hidden {
      display: none !important;
    }
    
    /* Modal animations */
    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
  </style>
  <script type="module" crossorigin src="/toasters-vs-loaves/assets/index-BVtnorRS.js"></script>
</head>
<body>
  <div class="wrap menu-mode">
    <div id="gamePanel">
      <canvas id="game" width="960" height="540"></canvas>
      <div class="hud">
        <div class="topbar">
          <div class="pill"><span>Coins: <b id="coins">0</b></span><span>Lives: <b id="lives">100</b></span><span>Wave: <b id="wave">0</b></span><span>AP (Appliance Pts): <b id="ap">0</b></span></div>
          <div class="pill" id="powerupDisplay" style="display:none;"><span>Active: <span id="activePowerups"></span></span></div>
          <button id="startBtn" class="pill btn primary">Start Wave</button>
          <button id="exitGameBtn" class="pill btn" style="background:var(--bad);color:white;display:none;">Exit to HQ</button>
          <div class="pill hint">Place toasters on the counter (dark tiles). Not on the loaf path (light tiles). Click powerups to collect!</div>
        </div>
      </div>
    </div>
    
    <!-- Tower Upgrade Popup -->
    <div id="towerUpgradePopup" class="tower-popup" style="display: none;">
      <div class="popup-content">
        <div class="popup-header">
          <h2 id="popupTowerName">Selected Tower</h2>
          <button class="popup-close" id="closePopup">Ã—</button>
        </div>
        <div class="popup-body">
          <div id="popupTowerStats"></div>
          <div id="popupUpgradePaths"></div>
          <div class="popup-actions">
            <button id="popupSellBtn" class="btn sell-btn">Sell Tower</button>
          </div>
        </div>
      </div>
    </div>
    
    <aside class="side">
      <div class="section">
        <h2>Tower Catalog</h2>
        <div class="catalog" id="catalog"></div>
        <div class="hint">Click a tower to select, then click counter to place. Hold <b>Shift</b> for multiple placements.</div>
      </div>
      
      <!-- Tech Tree moved down -->
      <div class="section">
        <h2>Kitchen Tech Tree</h2>
        <div class="tech-grid" id="tech"></div>
        <div class="hint">AP is earned each wave. Global upgrades buff all appliances.</div>
      </div>
      
      <!-- Abilities moved down -->
      <div class="section">
        <h3>Special Abilities</h3>
        <div id="abilitiesDisplay">
          <div class="hint">Hotkeys: Q, W, E, R. Abilities cost coins except Emergency Coins.</div>
        </div>
      </div>
      
      <!-- Controls section -->
      <div class="section">
        <h3>Controls</h3>
        <div class="row"><span>Show Ranges</span><input type="checkbox" id="rangeToggle" checked></div>
        <button id="sellBtn" class="btn small sell-btn" disabled>Sell Tower (No Selection)</button>
        <div class="hint">Select a placed tower to upgrade or sell it</div>
      </div>
      
      <!-- Achievements moved down -->
      <div class="section">
        <h3>Achievements</h3>
        <div id="achievementsDisplay">
          <div class="hint">Complete challenges to unlock achievements!</div>
        </div>
      </div>
      
      <!-- Event Log moved down -->
      <div class="section">
        <h3>Event Log</h3>
        <div class="log" id="log"></div>
      </div>
    </aside>
  </div>
</body>
</html>
